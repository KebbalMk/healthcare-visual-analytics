<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Visual Analytics Tool</title>
    
    <!-- D3.js Library -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- ArcGIS JavaScript API CSS -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        header h1 {
            color: #667eea;
            font-size: 36px;
            margin-bottom: 10px;
        }

        header p {
            color: #666;
            font-size: 16px;
        }

        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filters h3 {
            width: 100%;
            color: #333;
            margin-bottom: 10px;
        }

        .filters label {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-weight: 600;
            color: #555;
        }

        .filters select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-width: 180px;
            cursor: pointer;
        }

        .filters select:focus {
            outline: none;
            border-color: #667eea;
        }

        .filters button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .filters button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .chart-container h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        #testResultsChart, 
        #conditionsChart, 
        #billingChart, 
        #demographicsChart {
            min-height: 350px;
        }

        .map-section {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .map-section h3 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        #mapDiv {
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
        }

        .stats-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .stats-summary h3 {
            color: #333;
            margin-bottom: 20px;
        }

        #statsContainer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: scale(1.05);
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            background: white;
            padding: 30px 50px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: 600;
            color: #667eea;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filters label {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè• Healthcare Visual Analytics Dashboard</h1>
            <p>Interactive analysis of patient data, test results, and hospital statistics</p>
        </header>

        <div class="filters">
            <h3>üìä Filters</h3>
            <label>Hospital:
                <select id="hospitalFilter">
                    <option value="all">All Hospitals</option>
                </select>
            </label>
            
            <label>Medical Condition:
                <select id="conditionFilter">
                    <option value="all">All Conditions</option>
                </select>
            </label>
            
            <label>Test Result:
                <select id="testResultFilter">
                    <option value="all">All Results</option>
                    <option value="Normal">Normal</option>
                    <option value="Abnormal">Abnormal</option>
                    <option value="Inconclusive">Inconclusive</option>
                </select>
            </label>
            
            <button id="resetBtn">Reset Filters</button>
        </div>

        <div class="dashboard-grid">
            <div class="chart-container">
                <h3>Test Results Distribution</h3>
                <div id="testResultsChart"></div>
            </div>

            <div class="chart-container">
                <h3>Medical Conditions vs Test Results</h3>
                <div id="conditionsChart"></div>
            </div>

            <div class="chart-container">
                <h3>Billing Amount Distribution</h3>
                <div id="billingChart"></div>
            </div>

            <div class="chart-container">
                <h3>Patient Demographics (Age Groups)</h3>
                <div id="demographicsChart"></div>
            </div>
        </div>

        <div class="map-section">
            <h3>üó∫Ô∏è Hospital Geographic Distribution</h3>
            <div id="mapDiv"></div>
        </div>

        <div class="stats-summary">
            <h3>üìà Summary Statistics</h3>
            <div id="statsContainer">
                <div class="stat-card">
                    <div class="stat-value" id="totalPatients">-</div>
                    <div class="stat-label">Total Patients</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgBilling">-</div>
                    <div class="stat-label">Avg Billing ($)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgStay">-</div>
                    <div class="stat-label">Avg Stay (days)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalHospitals">-</div>
                    <div class="stat-label">Hospitals</div>
                </div>
            </div>
        </div>
    </div>

    <div id="loading" style="display: none;">
        <div class="spinner">Loading data...</div>
    </div>

    <script>
    // ============================================
    // GLOBAL VARIABLES
    // ============================================
    let globalData = [];
    let filteredData = [];
    const testResultColors = {
        'Normal': '#4CAF50',
        'Abnormal': '#F44336',
        'Inconclusive': '#FF9800'
    };

    const hospitalCoordinates = {
        "Smith PLC": [-74.0060, 40.7128],
        "Johnson Inc": [-118.2437, 34.0522],
        "Williams-Davis": [-87.6298, 41.8781],
        "Davis, Michael and Sons": [-95.3698, 29.7604],
        "Brown Group": [-112.0740, 33.4484],
        "Taylor LLC": [-75.1652, 39.9526],
        "Anderson-Smith": [-98.4936, 29.4241],
        "Thomas-Moore": [-117.1611, 32.7157],
        "Jackson-Scott": [-96.7970, 32.7767],
        "White and Sons": [-121.8863, 37.3382],
        "Harris, Kelly and Sons": [-97.7431, 30.2672],
        "Martin-Garcia": [-86.1581, 39.7684],
        "Thompson-King": [-82.9988, 39.9612],
        "Garcia Ltd": [-80.1918, 25.7617],
        "Martinez Inc": [-122.3321, 47.6062],
        "Robinson-Hernandez": [-104.9903, 39.7392],
        "Clark-Lopez": [-77.0369, 38.9072],
        "Rodriguez and Sons": [-71.0589, 42.3601],
        "Lewis and Sons": [-84.3880, 33.7490],
        "Lee LLC": [-93.2650, 44.9778],
        "Walker PLC": [-122.4194, 37.7749],
        "Hall-Allen": [-90.1994, 38.6270],
        "Young, Deborah and Sons": [-81.6944, 41.4993],
        "Hernandez Inc": [-80.8431, 35.2271],
        "King Ltd": [-111.8910, 40.7608]
    };

    // ============================================
    // DATA PREPROCESSING
    // ============================================
    function preprocessData(rawData) {
        console.log('üîÑ Starting data preprocessing...');
        
        let cleanedData = rawData.filter(d => {
            return d['Test Results'] && 
                   d.Age && 
                   d.Hospital && 
                   d['Medical Condition'] &&
                   d['Date of Admission'] &&
                   d['Discharge Date'];
        });
        
        console.log(`‚úÖ Removed ${rawData.length - cleanedData.length} rows with missing values`);
        
        cleanedData.forEach(d => {
            d.Age = parseInt(d.Age) || 0;
            d['Billing Amount'] = parseFloat(d['Billing Amount']) || 0;
            d.Gender = d.Gender || 'Unknown';
            d['Blood Type'] = d['Blood Type'] || 'Unknown';
            d.Medication = d.Medication || 'None';
            
            let admission = new Date(d['Date of Admission']);
            let discharge = new Date(d['Discharge Date']);
            d.LengthOfStay = Math.max(1, Math.ceil((discharge - admission) / (1000 * 60 * 60 * 24)));
            
            let age = d.Age;
            if (age <= 18) {
                d.AgeGroup = '0-18';
            } else if (age <= 40) {
                d.AgeGroup = '19-40';
            } else if (age <= 65) {
                d.AgeGroup = '41-65';
            } else {
                d.AgeGroup = '65+';
            }
            
            d['Test Results'] = d['Test Results'].trim();
        });
        
        console.log('‚úÖ Data preprocessing complete!');
        return cleanedData;
    }

    // ============================================
    // D3 VISUALIZATIONS
    // ============================================
    function createTestResultsChart(data) {
        d3.select('#testResultsChart').html('');
        let counts = d3.rollup(data, v => v.length, d => d['Test Results']);
        let chartData = Array.from(counts, ([key, value]) => ({ label: key, value: value }));
        
        const width = 450, height = 350, radius = Math.min(width, height) / 2 - 40;
        const svg = d3.select('#testResultsChart').append('svg').attr('width', width).attr('height', height)
            .append('g').attr('transform', `translate(${width/2}, ${height/2})`);
        
        const pie = d3.pie().value(d => d.value);
        const arc = d3.arc().innerRadius(0).outerRadius(radius);
        const arcHover = d3.arc().innerRadius(0).outerRadius(radius + 10);
        
        const tooltip = d3.select('body').append('div').attr('class', 'tooltip');
        
        svg.selectAll('path').data(pie(chartData)).enter().append('path')
            .attr('d', arc)
            .attr('fill', d => testResultColors[d.data.label])
            .attr('stroke', 'white')
            .attr('stroke-width', 2)
            .style('cursor', 'pointer')
            .on('mouseover', function(event, d) {
                d3.select(this).transition().duration(200).attr('d', arcHover);
                let percentage = ((d.data.value / data.length) * 100).toFixed(1);
                tooltip.transition().duration(200).style('opacity', 1);
                tooltip.html(`<strong>${d.data.label}</strong><br/>Count: ${d.data.value}<br/>Percentage: ${percentage}%`)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
            })
            .on('mouseout', function() {
                d3.select(this).transition().duration(200).attr('d', arc);
                tooltip.transition().duration(200).style('opacity', 0);
            });
        
        svg.selectAll('text').data(pie(chartData)).enter().append('text')
            .attr('transform', d => `translate(${arc.centroid(d)})`)
            .attr('text-anchor', 'middle')
            .attr('font-size', '14px')
            .attr('font-weight', 'bold')
            .attr('fill', 'white')
            .text(d => d.data.label);
    }

    function createConditionsChart(data) {
        d3.select('#conditionsChart').html('');
        
        let grouped = d3.rollup(data, v => v.length, d => d['Medical Condition'], d => d['Test Results']);
        let chartData = [];
        grouped.forEach((testResults, condition) => {
            let obj = { condition: condition };
            testResults.forEach((count, result) => { obj[result] = count; });
            chartData.push(obj);
        });
        
        chartData.sort((a, b) => {
            let totalA = (a.Normal || 0) + (a.Abnormal || 0) + (a.Inconclusive || 0);
            let totalB = (b.Normal || 0) + (b.Abnormal || 0) + (b.Inconclusive || 0);
            return totalB - totalA;
        });
        chartData = chartData.slice(0, 10);
        
        const margin = { top: 20, right: 120, bottom: 80, left: 60 };
        const width = 500 - margin.left - margin.right;
        const height = 350 - margin.top - margin.bottom;
        
        const svg = d3.select('#conditionsChart').append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
            .append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);
        
        const x0 = d3.scaleBand().domain(chartData.map(d => d.condition)).rangeRound([0, width]).paddingInner(0.1);
        const x1 = d3.scaleBand().domain(['Normal', 'Abnormal', 'Inconclusive']).rangeRound([0, x0.bandwidth()]).padding(0.05);
        const y = d3.scaleLinear().domain([0, d3.max(chartData, d => Math.max(d.Normal || 0, d.Abnormal || 0, d.Inconclusive || 0))]).nice().range([height, 0]);
        
        svg.append('g').attr('transform', `translate(0,${height})`).call(d3.axisBottom(x0))
            .selectAll('text').attr('transform', 'rotate(-45)').style('text-anchor', 'end').attr('font-size', '10px');
        svg.append('g').call(d3.axisLeft(y));
        
        const tooltip = d3.select('body').append('div').attr('class', 'tooltip');
        const conditions = svg.selectAll('.condition').data(chartData).enter().append('g')
            .attr('transform', d => `translate(${x0(d.condition)},0)`);
        
        ['Normal', 'Abnormal', 'Inconclusive'].forEach(result => {
            conditions.append('rect')
                .attr('x', x1(result))
                .attr('y', d => y(d[result] || 0))
                .attr('width', x1.bandwidth())
                .attr('height', d => height - y(d[result] || 0))
                .attr('fill', testResultColors[result])
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('opacity', 0.7);
                    tooltip.transition().duration(200).style('opacity', 1);
                    tooltip.html(`<strong>${d.condition}</strong><br/>${result}: ${d[result] || 0}`)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('opacity', 1);
                    tooltip.transition().duration(200).style('opacity', 0);
                });
        });
        
        const legend = svg.append('g').attr('transform', `translate(${width + 10}, 0)`);
        ['Normal', 'Abnormal', 'Inconclusive'].forEach((result, i) => {
            legend.append('rect').attr('x', 0).attr('y', i * 25).attr('width', 15).attr('height', 15).attr('fill', testResultColors[result]);
            legend.append('text').attr('x', 20).attr('y', i * 25 + 12).text(result).attr('font-size', '12px');
        });
    }

    function createBillingChart(data) {
        d3.select('#billingChart').html('');
        
        const margin = { top: 20, right: 30, bottom: 50, left: 70 };
        const width = 500 - margin.left - margin.right;
        const height = 350 - margin.top - margin.bottom;
        
        const svg = d3.select('#billingChart').append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
            .append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);
        
        const billingData = data.map(d => d['Billing Amount']);
        const histogram = d3.histogram().value(d => d).domain([0, d3.max(billingData)]).thresholds(20);
        const bins = histogram(billingData);
        
        const x = d3.scaleLinear().domain([0, d3.max(billingData)]).range([0, width]);
        const y = d3.scaleLinear().domain([0, d3.max(bins, d => d.length)]).nice().range([height, 0]);
        
        svg.append('g').attr('transform', `translate(0,${height})`).call(d3.axisBottom(x).tickFormat(d => '$' + d.toLocaleString()))
            .selectAll('text').attr('transform', 'rotate(-45)').style('text-anchor', 'end');
        svg.append('g').call(d3.axisLeft(y));
        
        const tooltip = d3.select('body').append('div').attr('class', 'tooltip');
        
        svg.selectAll('rect').data(bins).enter().append('rect')
            .attr('x', d => x(d.x0) + 1)
            .attr('y', d => y(d.length))
            .attr('width', d => Math.max(0, x(d.x1) - x(d.x0) - 2))
            .attr('height', d => height - y(d.length))
            .attr('fill', '#667eea')
            .attr('stroke', 'white')
            .style('cursor', 'pointer')
            .on('mouseover', function(event, d) {
                d3.select(this).attr('fill', '#5568d3');
                tooltip.transition().duration(200).style('opacity', 1);
                tooltip.html(`<strong>Range:</strong> $${d.x0.toFixed(0)} - $${d.x1.toFixed(0)}<br/><strong>Count:</strong> ${d.length}`)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
            })
            .on('mouseout', function() {
                d3.select(this).attr('fill', '#667eea');
                tooltip.transition().duration(200).style('opacity', 0);
            });
    }

    function createDemographicsChart(data) {
        d3.select('#demographicsChart').html('');
        
        const grouped = d3.rollup(data, v => v.length, d => d.AgeGroup, d => d.Gender);
        const ageGroups = ['0-18', '19-40', '41-65', '65+'];
        const chartData = ageGroups.map(ageGroup => {
            const genderData = grouped.get(ageGroup) || new Map();
            return {
                ageGroup: ageGroup,
                Male: -(genderData.get('Male') || 0),
                Female: genderData.get('Female') || 0
            };
        });
        
        const margin = { top: 20, right: 30, bottom: 50, left: 70 };
        const width = 500 - margin.left - margin.right;
        const height = 350 - margin.top - margin.bottom;
        
        const svg = d3.select('#demographicsChart').append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
            .append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);
        
        const x = d3.scaleLinear().domain([d3.min(chartData, d => d.Male), d3.max(chartData, d => d.Female)]).range([0, width]);
        const y = d3.scaleBand().domain(ageGroups).range([0, height]).padding(0.2);
        
        svg.append('g').attr('transform', `translate(0,${height})`).call(d3.axisBottom(x).tickFormat(d => Math.abs(d)));
        svg.append('g').attr('transform', `translate(${x(0)},0)`).call(d3.axisLeft(y));
        
        const tooltip = d3.select('body').append('div').attr('class', 'tooltip');
        
        svg.selectAll('.bar-male').data(chartData).enter().append('rect')
            .attr('x', d => x(d.Male))
            .attr('y', d => y(d.ageGroup))
            .attr('width', d => x(0) - x(d.Male))
            .attr('height', y.bandwidth())
            .attr('fill', '#4A90E2')
            .style('cursor', 'pointer')
            .on('mouseover', function(event, d) {
                d3.select(this).attr('opacity', 0.7);
                tooltip.transition().duration(200).style('opacity', 1);
                tooltip.html(`<strong>Age: ${d.ageGroup}</strong><br/>Male: ${Math.abs(d.Male)}`)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
            })
            .on('mouseout', function() {
                d3.select(this).attr('opacity', 1);
                tooltip.transition().duration(200).style('opacity', 0);
            });
        
        svg.selectAll('.bar-female').data(chartData).enter().append('rect')
            .attr('x', x(0))
            .attr('y', d => y(d.ageGroup))
            .attr('width', d => x(d.Female) - x(0))
            .attr('height', y.bandwidth())
            .attr('fill', '#E91E63')
            .style('cursor', 'pointer')
            .on('mouseover', function(event, d) {
                d3.select(this).attr('opacity', 0.7);
                tooltip.transition().duration(200).style('opacity', 1);
                tooltip.html(`<strong>Age: ${d.ageGroup}</strong><br/>Female: ${d.Female}`)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
            })
            .on('mouseout', function() {
                d3.select(this).attr('opacity', 1);
                tooltip.transition().duration(200).style('opacity', 0);
            });
        
        svg.append('text').attr('x', x(0) - 80).attr('y', -5).text('Male').attr('font-weight', 'bold').attr('fill', '#4A90E2');
        svg.append('text').attr('x', x(0) + 10).attr('y', -5).text('Female').attr('font-weight', 'bold').attr('fill', '#E91E63');
    }

    // ============================================
    // ARCGIS MAP
    // ============================================
    function initializeMap() {
        console.log('üó∫Ô∏è Initializing ArcGIS map...');
        
        if (typeof require === 'undefined') {
            console.error('‚ö† ArcGIS loader not available yet, retrying...');
            setTimeout(initializeMap, 500);
            return;
        }
        
        const hospitalData = aggregateHospitalData(globalData);
        
        require(["esri/Map", "esri/views/MapView", "esri/Graphic", "esri/layers/GraphicsLayer"], 
        function(Map, MapView, Graphic, GraphicsLayer) {
            const map = new Map({ basemap: "streets-navigation-vector" });
            const view = new MapView({ container: "mapDiv", map: map, center: [-98, 39.5], zoom: 4 });
            const graphicsLayer = new GraphicsLayer();
            map.add(graphicsLayer);
            
            hospitalData.forEach(hospital => {
                const coords = hospitalCoordinates[hospital.name];
                
                if (coords) {
                    let markerColor;
                    switch (hospital.dominantResult) {
                        case 'Normal':
                            markerColor = [76, 175, 80];
                            break;
                        case 'Abnormal':
                            markerColor = [244, 67, 54];
                            break;
                        case 'Inconclusive':
                            markerColor = [255, 152, 0];
                            break;
                        default:
                            markerColor = [102, 126, 234];
                    }
                    
                    const markerSize = Math.min(40, Math.max(12, hospital.patientCount / 10));
                    
                    const graphic = new Graphic({
                        geometry: {
                            type: "point",
                            longitude: coords[0],
                            latitude: coords[1]
                        },
                        symbol: {
                            type: "simple-marker",
                            color: markerColor,
                            size: markerSize,
                            outline: {
                                color: [255, 255, 255],
                                width: 2
                            }
                        },
                        attributes: {
                            name: hospital.name,
                            patientCount: hospital.patientCount,
                            avgBilling: hospital.avgBilling.toFixed(2),
                            avgStay: hospital.avgStay.toFixed(1),
                            dominantResult: hospital.dominantResult,
                            normalCount: hospital.testResults.get('Normal') || 0,
                            abnormalCount: hospital.testResults.get('Abnormal') || 0,
                            inconclusiveCount: hospital.testResults.get('Inconclusive') || 0
                        },
                        popupTemplate: {
                            title: "üè• {name}",
                            content: `
                                <div style="padding: 10px;">
                                    <p><strong>üìä Statistics:</strong></p>
                                    <ul style="margin: 5px 0; padding-left: 20px;">
                                        <li><strong>Patients:</strong> {patientCount}</li>
                                        <li><strong>Avg Billing:</strong> ${hospital.avgBilling.toFixed(2)}</li>
                                        <li><strong>Avg Stay:</strong> {avgStay} days</li>
                                    </ul>
                                    <p style="margin-top: 10px;"><strong>üß™ Test Results:</strong></p>
                                    <ul style="margin: 5px 0; padding-left: 20px;">
                                        <li style="color: #4CAF50;"><strong>Normal:</strong> {normalCount}</li>
                                        <li style="color: #F44336;"><strong>Abnormal:</strong> {abnormalCount}</li>
                                        <li style="color: #FF9800;"><strong>Inconclusive:</strong> {inconclusiveCount}</li>
                                    </ul>
                                    <p style="margin-top: 10px; padding: 8px; background: #f0f0f0; border-radius: 4px; text-align: center;">
                                        <strong>Dominant Result:</strong> 
                                        <span style="color: ${markerColor[0] === 76 ? '#4CAF50' : markerColor[0] === 244 ? '#F44336' : '#FF9800'};">
                                            {dominantResult}
                                        </span>
                                    </p>
                                </div>
                            `
                        }
                    });
                    
                    graphicsLayer.add(graphic);
                }
            });
            
            view.on("click", function(event) {
                view.hitTest(event).then(function(response) {
                    if (response.results.length > 0) {
                        const graphic = response.results[0].graphic;
                        if (graphic.attributes && graphic.attributes.name) {
                            document.getElementById('hospitalFilter').value = graphic.attributes.name;
                            applyFilters();
                            view.popup.open({
                                location: event.mapPoint,
                                features: [graphic]
                            });
                        }
                    }
                });
            });
            
            console.log('‚úÖ Map initialized with', hospitalData.length, 'hospitals');
        });
    }

    function aggregateHospitalData(data) {
        const hospitalMap = d3.rollup(data,
            v => ({
                patientCount: v.length,
                avgBilling: d3.mean(v, d => d['Billing Amount']),
                avgStay: d3.mean(v, d => d.LengthOfStay),
                testResults: d3.rollup(v, v2 => v2.length, d => d['Test Results']),
                dominantResult: getDominantTestResult(v)
            }),
            d => d.Hospital
        );
        
        const hospitalArray = [];
        hospitalMap.forEach((stats, name) => {
            hospitalArray.push({
                name: name,
                ...stats
            });
        });
        
        return hospitalArray;
    }

    function getDominantTestResult(patients) {
        const counts = d3.rollup(patients, v => v.length, d => d['Test Results']);
        
        let maxCount = 0;
        let dominant = 'Normal';
        
        counts.forEach((count, result) => {
            if (count > maxCount) {
                maxCount = count;
                dominant = result;
            }
        });
        
        return dominant;
    }

    // ============================================
    // MAIN FUNCTIONS
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Page loaded, starting data load...');
        showLoading();
        loadData();
    });

    function showLoading() {
        document.getElementById('loading').style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loading').style.display = 'none';
    }

    function loadData() {
        const csvPath = 'data/healthcare_data.csv';
        
        console.log('üìÇ Attempting to load CSV from:', csvPath);
        
        d3.csv(csvPath)
            .then(function(data) {
                console.log('‚úÖ Data loaded:', data.length, 'records');
                
                globalData = preprocessData(data);
                filteredData = [...globalData];
                
                console.log('‚úÖ Data preprocessed:', globalData.length, 'records');
                
                initializeFilters();
                updateAllVisualizations();
                updateStatistics();
                
                setTimeout(function() {
                    initializeMap();
                }, 1000);
                
                hideLoading();
            })
            .catch(function(error) {
                console.error('‚ùå Error loading data:', error);
                hideLoading();
                
                alert('Failed to load data. Please check:\n' +
                      '1. File exists at: data/healthcare_data.csv\n' +
                      '2. You are running a local server (not opening HTML directly)\n' +
                      '3. Check browser console for details');
            });
    }

    function initializeFilters() {
        let hospitals = [...new Set(globalData.map(d => d.Hospital))].sort();
        let hospitalSelect = document.getElementById('hospitalFilter');
        hospitals.forEach(hospital => {
            let option = document.createElement('option');
            option.value = hospital;
            option.textContent = hospital;
            hospitalSelect.appendChild(option);
        });
        
        console.log('üè• Loaded', hospitals.length, 'hospitals');
        
        let conditions = [...new Set(globalData.map(d => d['Medical Condition']))].sort();
        let conditionSelect = document.getElementById('conditionFilter');
        conditions.forEach(condition => {
            let option = document.createElement('option');
            option.value = condition;
            option.textContent = condition;
            conditionSelect.appendChild(option);
        });
        
        console.log('üè• Loaded', conditions.length, 'medical conditions');
        
        document.getElementById('hospitalFilter').addEventListener('change', applyFilters);
        document.getElementById('conditionFilter').addEventListener('change', applyFilters);
        document.getElementById('testResultFilter').addEventListener('change', applyFilters);
        document.getElementById('resetBtn').addEventListener('click', resetFilters);
    }

    function applyFilters() {
        let hospitalFilter = document.getElementById('hospitalFilter').value;
        let conditionFilter = document.getElementById('conditionFilter').value;
        let testResultFilter = document.getElementById('testResultFilter').value;
        
        filteredData = globalData.filter(d => {
            let matchHospital = hospitalFilter === 'all' || d.Hospital === hospitalFilter;
            let matchCondition = conditionFilter === 'all' || d['Medical Condition'] === conditionFilter;
            let matchTestResult = testResultFilter === 'all' || d['Test Results'] === testResultFilter;
            
            return matchHospital && matchCondition && matchTestResult;
        });
        
        console.log('üîç Filtered:', filteredData.length, 'records out of', globalData.length);
        
        updateAllVisualizations();
        updateStatistics();
    }

    function resetFilters() {
        document.getElementById('hospitalFilter').value = 'all';
        document.getElementById('conditionFilter').value = 'all';
        document.getElementById('testResultFilter').value = 'all';
        
        filteredData = [...globalData];
        console.log('üîÑ Filters reset');
        
        updateAllVisualizations();
        updateStatistics();
    }

    function updateAllVisualizations() {
        console.log('üìä Updating all visualizations...');
        
        createTestResultsChart(filteredData);
        createConditionsChart(filteredData);
        createBillingChart(filteredData);
        createDemographicsChart(filteredData);
        
        console.log('‚úÖ All visualizations updated');
    }

    function updateStatistics() {
        document.getElementById('totalPatients').textContent = filteredData.length.toLocaleString();
        
        let avgBilling = d3.mean(filteredData, d => d['Billing Amount']);
        document.getElementById('avgBilling').textContent = ' + avgBilling.toFixed(2);
        
        let avgStay = d3.mean(filteredData, d => d.LengthOfStay);
        document.getElementById('avgStay').textContent = avgStay.toFixed(1);
        
        let hospitals = new Set(filteredData.map(d => d.Hospital));
        document.getElementById('totalHospitals').textContent = hospitals.size;
        
        console.log('üìà Statistics updated');
    }
    </script>

    <!-- ArcGIS JavaScript API -->
    <script src="https://js.arcgis.com/4.28/"></script>
</body>
</html>
